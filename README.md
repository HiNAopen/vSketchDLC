<<<<<<< HEAD
# vSketchDLC
=======

vSketchDLC is a fine-grained and user-friendly 
communication measurement tool implemented in ps-lite, which 
is a light and efficient implementation of the parameter server framework and 
applied by deep learning frameworks such as MXNet.
vSketchDLC can trace low-level communication events between 
framework and communication library interface, and capture 
end-to-end push and pull communications between workers and servers. 

The main implementation of vSketchDLC is in 
https://github.com/HiNAopen/vSketchDLC/blob/main/ps-lite/include/ps/internal/timeline.h 
and https://github.com/HiNAopen/vSketchDLC/blob/main/ps-lite/src/timeline.cc
- `timeline.h`: define TimelineRecord Struct with Timeline Class and TimelineWriter Class
- `timeline.cc`: create communication record files and write records in standard format

The communication records generated by vSketchDLC can be visualized by Chrome Trace Viewer.
After inputting chrome://tracing/ in Google browser, we can load the record file.

### Capturing fine-grained communication records

- Communications according to DNN layers

MXNet uses the priority variable as the division basis of DNN layer, 
so vSketchDLC can divide communications according to this variable.
This feature of vSKetchDLC requires MXNet to simply add priority variables when using ps-lite.

In MXNet kvstore_dist.h:

```c++ MXNet kvstore_dist.h 
  auto pull_from_servers = [this, key, recv_buf, priority](
  ...
  CHECK_NOTNULL(ps_worker_)->ZPull(
    pskv.keys, vals, &pskv.lens, cmd, [vals, cb](){ delete vals; cb(); }, priority);
```

ZPull is a function in ps-lite, from which vSketchDLC gets the basis for dividing the DNN layer. 
Accordingly, in kvstore_dist.h, the place where ZPush and ZPull functions are called needs to be modified.

- Fine-grained communication records

MXNet profiler can only record operator-level communications, such as push operator and pull operator. 
Instead, vSketchDLC can capture fine-grained low-level communication operations inside MXNet communication operators.
In ps-lite, an communication operator actually performs two network transmissions and one server message processing.

vSketchDLC records time points in four functions of ps-lite in https://github.com/HiNAopen/vSketchDLC/blob/main/ps-lite/include/ps/kv_app.h 
and https://github.com/HiNAopen/vSketchDLC/blob/main/ps-lite/include/ps/internal/customer.h

```c++ ps-lite kv_app.h
  void KVWorker<Val>::Send(
  ...
  msg.meta.request_begin = obj_->timeline()->TimeFromUTC();
```

```c++ ps-lite customer.h
  inline void Accept(Message& recved) {
    // push/pull request/response end
    if (recved.meta.request) {
      recved.meta.request_end = this->timeline_->TimeFromUTC();
    } else {
      recved.meta.response_end = this->timeline_->TimeFromUTC();
    }
    recv_queue_.Push(recved);
  }
```

```c++ ps-lite kv_app.h
  KVServer<Val>::Response(
  ...
  msg.meta.request_begin = req.request_begin;
  msg.meta.request_end = req.request_end;
  msg.meta.response_begin = obj_->timeline()->TimeFromUTC();
```

```c++ ps-lite kv_app.h
  void KVWorker<Val>::Process(
  ...
  obj_->timeline()->Write(msg.meta);
```

Compared with previous work SketchDLC and MXNet profiler, vSketchDLC not only visualizes communication records, 
but also starts a asynchronous record thread on each worker to write files and avoid affecting training performance.

### Build

`ps-lite` requires a C++11 compiler such as `g++ >= 4.8`. On Ubuntu >= 13.10, we
can install it by

```bash
cd ps-lite && make -j4
```